<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é»˜å¥‘å¤§è€ƒé©— (æ–°é¡Œç›®ç‰ˆ)</title>
    <!-- å¼•å…¥ PeerJS å’Œ QRCode -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { margin: 0; font-family: "Helvetica", sans-serif; background: #222; color: white; text-align: center; overflow: hidden; user-select: none; }
        .screen { display: none; height: 100vh; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        
        h1 { margin-bottom: 10px; font-size: 26px; letter-spacing: 1px; }
        p { color: #ccc; margin-bottom: 30px; }
        
        input { padding: 12px; border-radius: 8px; border: none; font-size: 18px; text-align: center; width: 80%; margin-bottom: 15px; }
        
        button { padding: 18px 30px; border-radius: 30px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; width: 85%; max-width: 320px; margin: 12px 0; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-create { background: linear-gradient(45deg, #ff6b6b, #ee5253); color: white; }
        .btn-join { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; }
        .btn-copy { background: #666; color: white; font-size: 14px; padding: 10px; width: auto; box-shadow: none; }

        #game-area { width: 100%; max-width: 400px; position: relative; }
        /* èª¿æ•´å¡ç‰‡é«˜åº¦ */
        .question-card { background: white; color: #333; padding: 20px; border-radius: 20px; font-size: 20px; font-weight: bold; margin-bottom: 20px; min-height: 100px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); line-height: 1.4; }
        
        /* é¸é …æŒ‰éˆ•æ¨£å¼ */
        .choice-btn { display: block; width: 100%; padding: 15px; margin-bottom: 12px; border: none; border-radius: 15px; font-size: 18px; color: white; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        
        .btn-a { background: #4facfe; } /* è—è‰² */
        .btn-b { background: #f093fb; } /* ç²‰è‰² */
        .btn-c { background: #20bf6b; } /* ç¶ è‰² */

        .btn-disabled { opacity: 0.5; pointer-events: none; }
        .choice-btn:active { transform: scale(0.98); }

        #feedback { font-size: 80px; font-weight: 900; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); width: 100%; text-shadow: 0 5px 20px rgba(0,0,0,0.6); display: none; z-index: 99; }

        #qrcode { background: white; padding: 10px; margin: 10px auto; display: inline-block; border-radius: 10px; }
        .status-tag { background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 15px; font-size: 13px; margin-top: 15px; color: #aaa; }
    </style>
</head>
<body>

    <!-- 1. é¦–é  -->
    <div id="screen-home" class="screen active">
        <h1>ğŸ’ æ›¸é©åœˆï½œé»˜å¥‘å¤§è€ƒé©—</h1>
        <p>çµ‚æ¥µä¸‰é¸ä¸€ï¼ŒSTARTï¼</p>
        <button class="btn-create" onclick="createRoom()">æˆ‘æ˜¯ç™¼èµ·è€…ï¼ˆé–‹å§‹éŠæˆ²ï¼‰</button>
        <button class="btn-join" onclick="toJoinScreen()">æˆ‘æ˜¯æŒ‘æˆ°è€…ï¼ˆåŠ å…¥æŒ‘æˆ°ï¼‰</button>
    </div>

    <!-- 2. ç™¼èµ·è€…ç­‰å¾…å€ -->
    <div id="screen-host" class="screen">
        <h2>ç­‰å¾…æŒ‘æˆ°è€…...</h2>
        <div id="qrcode"></div>
        <p style="font-size: 14px; margin-top:10px;">è«‹å°æ–¹æƒææˆ–è¼¸å…¥ä¸‹æ–¹ä»£ç¢¼ï¼š</p>
        <h1 id="my-id-display" style="color:#ff6b6b; letter-spacing: 3px; font-size: 40px;">---</h1>
        <button class="btn-copy" onclick="copyID()">è¤‡è£½ä»£ç¢¼</button>
        <div class="status-tag" id="host-status">æ­£åœ¨å»ºç«‹é€£ç·šä¼ºæœå™¨...</div>
        <button onclick="location.reload()" style="background: transparent; border: 1px solid #555; color: #888; font-size: 14px; margin-top: 30px; width: auto; padding: 10px 20px;">å–æ¶ˆ</button>
    </div>

    <!-- 3. æŒ‘æˆ°è€…è¼¸å…¥å€ -->
    <div id="screen-join" class="screen">
        <h2>åŠ å…¥æŒ‘æˆ°</h2>
        <p>è«‹è¼¸å…¥ç™¼èµ·è€…ç•«é¢ä¸Šçš„ä»£ç¢¼</p>
        <input type="tel" id="input-id" placeholder="ä¾‹å¦‚: 1234" maxlength="4">
        <button class="btn-join" onclick="joinRoom()">é€£ç·šï¼</button>
        <div class="status-tag" id="join-status">æº–å‚™ä¸­...</div>
        <button onclick="location.reload()" style="background: transparent; border: 1px solid #555; color: #888; font-size: 14px; margin-top: 30px; width: auto; padding: 10px 20px;">è¿”å›</button>
    </div>

    <!-- 4. éŠæˆ²é€²è¡Œå€ -->
    <div id="screen-game" class="screen">
        <div id="game-area">
            <div id="feedback"></div>
            <div class="question-card" id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
            
            <button class="choice-btn btn-a" id="btn-a" onclick="makeChoice('a')">é¸é … A</button>
            <button class="choice-btn btn-b" id="btn-b" onclick="makeChoice('b')">é¸é … B</button>
            <button class="choice-btn btn-c" id="btn-c" onclick="makeChoice('c')">é¸é … C</button>
            
        </div>
        <div class="status-tag" id="game-status">éŠæˆ²é€²è¡Œä¸­</div>
    </div>

    <!-- 5. çµç®—å€ -->
    <div id="screen-result" class="screen">
        <h2>æœ€çµ‚é»˜å¥‘æŒ‡æ•¸</h2>
        <div style="font-size: 90px; font-weight: bold; margin: 20px 0; color: #f093fb;" id="final-score">0%</div>
        <p id="final-comment" style="font-size: 20px; color: white;">åˆ†æä¸­...</p>
        <button class="btn-create" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
    </div>

    <script>
        // --- é¡Œåº« (å·²æ›´æ–°ç‚ºä½ çš„é¡Œç›®) ---
        const questions = [
            { q: "ä½ æœ€å–œæ­¡çœ‹å“ªç¨®é¡å‹çš„æ›¸ï¼Ÿ", a: "æ–‡å­¸å°èªª", b: "å•†æ¥­ç†è²¡", c: "å¿ƒç†å‹µå¿—" },
            { q: "éºµç·šé€ä¾†æ™‚ï¼Œä½ çš„é¸æ“‡æ˜¯ï¼Ÿ", a: "è€é—†ï¼é¦™èœåŠ çˆ†", b: "çµ•å°ä¸è¦é¦™èœ", c: "æˆ‘è¨å­éºµç·š" },
            { q: "ä½ æ˜¯ä»€éº¼ä½œæ¯å‹ï¼Ÿ", a: "æ—©èµ·é³¥", b: "å¤œè²“å­", c: "æ··äº‚çš„ä½œæ¯" },
            { q: "é›»å½±çµå±€æ˜¯æ‚²åŠ‡ (Bad Ending)ï¼Œä½ æœƒï¼Ÿ", a: "è¦ºå¾—å¾Œå‹å¼·ï¼Œå–œæ­¡", b: "å¿ƒæƒ…ä¸å¥½ï¼Œä¸å–œæ­¡", c: "äººç”Ÿå¤ªè‹¦ï¼Œä¸çœ‹æ‚²åŠ‡" },
            { q: "é‡åˆ°å–œæ­¡çš„äººï¼Œä½ æœƒï¼Ÿ", a: "ä¸»å‹•å‡ºæ“Š", b: "æš—ç¤ºè©¦æ¢", c: "åªæ•¢å·å·æš—æˆ€" }
        ];

        // --- é€£ç·šè¨­å®š ---
        const peerConfig = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        };

        // --- è®Šæ•¸ ---
        let peer;
        let conn;
        let myRole = ''; 
        let currentQIndex = 0;
        let myChoice = null;
        let opponentChoice = null;
        let score = 0;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- ç™¼èµ·è€…é‚è¼¯ ---
        function createRoom() {
            myRole = 'host';
            showScreen('screen-host');
            const randomID = Math.floor(1000 + Math.random() * 9000).toString();
            
            peer = new Peer(randomID, peerConfig); 

            peer.on('open', (id) => {
                document.getElementById('host-status').innerText = "æˆ¿é–“å·²å»ºç«‹ï¼Œç­‰å¾…æŒ‘æˆ°è€…...";
                document.getElementById('my-id-display').innerText = id;
                
                document.getElementById("qrcode").innerHTML = "";
                new QRCode(document.getElementById("qrcode"), {
                    text: window.location.href, 
                    width: 180,
                    height: 180
                });
            });

            peer.on('connection', (c) => {
                conn = c;
                setupConnection();
                document.getElementById('host-status').innerText = "é€£ç·šæˆåŠŸï¼å³å°‡é–‹å§‹...";
                setTimeout(startGame, 1500);
            });
            
            peer.on('error', (err) => {
                if(err.type === 'peer-unavailable') return;
                alert('ç¶²è·¯é€£ç·šä¸ç©©ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é å†è©¦ä¸€æ¬¡');
                location.reload();
            });
        }

        function copyID() {
            const id = document.getElementById('my-id-display').innerText;
            navigator.clipboard.writeText(id);
            alert('å·²è¤‡è£½ä»£ç¢¼: ' + id);
        }

        // --- æŒ‘æˆ°è€…é‚è¼¯ ---
        function toJoinScreen() {
            showScreen('screen-join');
        }

        function joinRoom() {
            const targetID = document.getElementById('input-id').value;
            if(targetID.length !== 4) return alert('è«‹è¼¸å…¥ 4 ä½æ•¸ä»£ç¢¼');

            document.getElementById('join-status').innerText = "æ­£åœ¨æœå°‹æˆ¿é–“...";
            myRole = 'client';
            
            peer = new Peer(null, peerConfig); 

            peer.on('open', () => {
                document.getElementById('join-status').innerText = "é€£ç·šä¸­...";
                conn = peer.connect(targetID);
                
                conn.on('open', () => {
                    document.getElementById('join-status').innerText = "é€£ç·šæˆåŠŸï¼";
                    setupConnection();
                });
                
                setTimeout(() => {
                    if(!conn.open) {
                        document.getElementById('join-status').innerText = "é€£ç·šè¶…æ™‚";
                        alert('é€£ç·šå¤±æ•—ï¼è«‹ç¢ºèªä»£ç¢¼æ­£ç¢ºæˆ–ç¶²è·¯æš¢é€šã€‚');
                    }
                }, 8000);
            });

            peer.on('error', (err) => {
                if(err.type === 'peer-unavailable') {
                    alert('æ‰¾ä¸åˆ°é€™å€‹ä»£ç¢¼ï¼Œè«‹ç¢ºèªç™¼èµ·è€…æ˜¯å¦é‚„åœ¨ç­‰å¾…ç•«é¢ä¸Šã€‚');
                } else {
                    alert('é€£ç·šéŒ¯èª¤: ' + err.type);
                }
                document.getElementById('join-status').innerText = "éŒ¯èª¤";
            });
        }

        // --- å…±é€šé€£ç·šè™•ç† ---
        function setupConnection() {
            conn.on('data', (data) => {
                handleData(data);
            });
        }

        function handleData(data) {
            if (data.type === 'new_question') {
                showScreen('screen-game');
                resetRound();
                document.getElementById('q-text').innerText = data.q.q;
                document.getElementById('btn-a').innerText = data.q.a;
                document.getElementById('btn-b').innerText = data.q.b;
                document.getElementById('btn-c').innerText = data.q.c;
                currentQIndex = data.index;
                
            } else if (data.type === 'opponent_choice') {
                opponentChoice = data.choice;
                checkResult();

            } else if (data.type === 'round_result') {
                showFeedback(data.match);
                
            } else if (data.type === 'game_over') {
                showResult(data.score);
            }
        }

        // --- éŠæˆ²æµç¨‹ ---
        function startGame() {
            score = 0;
            currentQIndex = 0;
            sendQuestion();
        }

        function sendQuestion() {
            if (currentQIndex >= questions.length) {
                const resultData = { type: 'game_over', score: score };
                conn.send(resultData);
                showResult(score);
                return;
            }
            
            const q = questions[currentQIndex];
            handleData({ type: 'new_question', q: q, index: currentQIndex });
            conn.send({ type: 'new_question', q: q, index: currentQIndex });
        }

        function resetRound() {
            myChoice = null;
            opponentChoice = null;
            document.getElementById('feedback').style.display = 'none';
            
            ['a', 'b', 'c'].forEach(opt => {
                const btn = document.getElementById('btn-' + opt);
                btn.classList.remove('btn-disabled');
                btn.style.opacity = '1';
            });
        }

        function makeChoice(choice) {
            if (myChoice) return; 
            myChoice = choice;
            
            ['a', 'b', 'c'].forEach(opt => {
                const btn = document.getElementById('btn-' + opt);
                btn.classList.add('btn-disabled');
                if (opt !== choice) {
                    btn.style.opacity = '0.3';
                } else {
                    btn.style.opacity = '1';
                }
            });

            conn.send({ type: 'opponent_choice', choice: choice });
            
            document.getElementById('game-status').innerText = "ç­‰å¾…å°æ–¹é¸æ“‡...";
            checkResult();
        }

        function checkResult() {
            if (myRole === 'host' && myChoice && opponentChoice) {
                const match = (myChoice === opponentChoice);
                if (match) score++;
                
                showFeedback(match);
                conn.send({ type: 'round_result', match: match });

                setTimeout(() => {
                    currentQIndex++;
                    sendQuestion();
                }, 2000);
            }
        }

        function showFeedback(match) {
            const fb = document.getElementById('feedback');
            fb.innerText = match ? "â­•" : "âŒ";
            fb.style.color = match ? "#42e695" : "#ff4757";
            fb.style.display = 'block';
        }

        function showResult(finalScore) {
            showScreen('screen-result');
            const percentage = Math.round((finalScore / questions.length) * 100);
            document.getElementById('final-score').innerText = percentage + "%";
            
            let comment = "";
            if (percentage == 100) comment = "å¤©ä½œä¹‹åˆï¼é€™æ˜¯å‘½é‹å§ï¼";
            else if (percentage >= 80) comment = "é»˜å¥‘è¶…å¥½ï¼å¿«ç´„ä¸‹æ¬¡åƒé£¯ï¼";
            else if (percentage >= 60) comment = "è »åˆå¾—ä¾†çš„å–”ï¼Œæœ‰å¾ˆå¤šè©±é¡Œå¯èŠ";
            else if (percentage >= 40) comment = "æ€§æ ¼äº’è£œï¼Œåè€Œæ›´æœ‰ç«èŠ±ï¼Ÿ";
            else comment = "ä¸–ç•Œè§€å®Œå…¨ä¸åŒï¼Œé€™å¤ªæœ‰è¶£äº†ï¼";
            document.getElementById('final-comment').innerText = comment;
        }
    </script>
</body>
</html>
