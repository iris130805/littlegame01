<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿ƒå‹•åˆ†æ­§é» (P2Pç‰ˆ)</title>
    <!-- å¼•å…¥ PeerJS (é€£ç·šç”¨) å’Œ QRCode.js (ç”¢ç”ŸQRç¢¼ç”¨) -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { margin: 0; font-family: "Helvetica", sans-serif; background: #222; color: white; text-align: center; overflow: hidden; user-select: none; }
        .screen { display: none; height: 100vh; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        
        h1 { margin-bottom: 10px; font-size: 24px; }
        p { color: #ccc; margin-bottom: 20px; }
        
        input { padding: 12px; border-radius: 8px; border: none; font-size: 18px; text-align: center; width: 80%; margin-bottom: 15px; }
        
        button { padding: 15px 30px; border-radius: 25px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; width: 80%; max-width: 300px; margin: 10px 0; transition: 0.2s; }
        .btn-create { background: #ff6b6b; color: white; }
        .btn-join { background: #4facfe; color: white; }
        .btn-copy { background: #666; color: white; font-size: 14px; padding: 10px; width: auto; }

        #game-area { width: 100%; max-width: 400px; position: relative; }
        .question-card { background: white; color: #333; padding: 20px; border-radius: 15px; font-size: 20px; font-weight: bold; margin-bottom: 30px; min-height: 100px; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        .choice-btn { display: block; width: 100%; padding: 20px; margin-bottom: 15px; border: none; border-radius: 15px; font-size: 18px; color: white; font-weight: bold; cursor: pointer; }
        .btn-a { background: #4facfe; } 
        .btn-b { background: #f093fb; }
        .btn-disabled { opacity: 0.5; pointer-events: none; }

        #feedback { font-size: 60px; font-weight: 900; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; text-shadow: 0 0 10px rgba(0,0,0,0.5); display: none; z-index: 99; }

        #qrcode { background: white; padding: 10px; margin: 10px auto; display: inline-block; border-radius: 10px; }
        .status-tag { background: #333; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-top: 10px; color: #888; }
    </style>
</head>
<body>

    <!-- 1. é¦–é  -->
    <div id="screen-home" class="screen active">
        <h1>ğŸ’ å¿ƒå‹•åˆ†æ­§é»</h1>
        <p>ç„¡éœ€å®‰è£ï¼Œå³æ™‚é€£ç·š</p>
        <button class="btn-create" onclick="createRoom()">æˆ‘æ˜¯æˆ¿ä¸» (é–‹æˆ¿é–“)</button>
        <button class="btn-join" onclick="toJoinScreen()">æˆ‘æ˜¯åƒåŠ è€… (åŠ å…¥)</button>
    </div>

    <!-- 2. æˆ¿ä¸»ç­‰å¾…å€ -->
    <div id="screen-host" class="screen">
        <h2>ç­‰å¾…åƒåŠ è€…...</h2>
        <div id="qrcode"></div>
        <p style="font-size: 14px; margin-top:10px;">è«‹å°æ–¹æƒææˆ–è¼¸å…¥ä¸‹æ–¹ä»£ç¢¼ï¼š</p>
        <h1 id="my-id-display" style="color:#ff6b6b; letter-spacing: 2px;">---</h1>
        <button class="btn-copy" onclick="copyID()">è¤‡è£½ä»£ç¢¼</button>
        <div class="status-tag" id="host-status">æ­£åœ¨é€£ç·šåˆ°ä¼ºæœå™¨...</div>
        <button onclick="location.reload()" style="background: transparent; border: 1px solid #666; color: #888; font-size: 14px; margin-top: 20px;">å–æ¶ˆ</button>
    </div>

    <!-- 3. åƒåŠ è€…è¼¸å…¥å€ -->
    <div id="screen-join" class="screen">
        <h2>åŠ å…¥æˆ¿é–“</h2>
        <input type="text" id="input-id" placeholder="è¼¸å…¥æˆ¿ä¸»ä»£ç¢¼ (ä¾‹å¦‚: ABCD)">
        <button class="btn-join" onclick="joinRoom()">é€£ç·šï¼</button>
        <div class="status-tag" id="join-status">æº–å‚™ä¸­...</div>
        <button onclick="location.reload()" style="background: transparent; border: 1px solid #666; color: #888; font-size: 14px; margin-top: 20px;">è¿”å›</button>
    </div>

    <!-- 4. éŠæˆ²é€²è¡Œå€ -->
    <div id="screen-game" class="screen">
        <div id="game-area">
            <div id="feedback"></div>
            <div class="question-card" id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
            <button class="choice-btn btn-a" id="btn-a" onclick="makeChoice('a')">é¸é … A</button>
            <button class="choice-btn btn-b" id="btn-b" onclick="makeChoice('b')">é¸é … B</button>
        </div>
        <div class="status-tag" id="game-status">éŠæˆ²é€²è¡Œä¸­</div>
    </div>

    <!-- 5. çµç®—å€ -->
    <div id="screen-result" class="screen">
        <h2>é»˜å¥‘æŒ‡æ•¸</h2>
        <div style="font-size: 80px; font-weight: bold; margin: 20px 0;" id="final-score">0%</div>
        <p id="final-comment">åˆ†æä¸­...</p>
        <button class="btn-create" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
    </div>

    <script>
        // --- é¡Œåº« ---
        const questions = [
            { q: "é€±æœ«å»æ›¸åº—ï¼Œä½ æœƒå…ˆé€›å“ªå€ï¼Ÿ", a: "æš¢éŠ·æ’è¡Œæ¦œ", b: "è§’è½å†·é–€æ›¸" },
            { q: "çœ‹åˆ°ä¸€åŠä¸»è§’åšäº†è ¢äº‹ï¼Ÿ", a: "æ°£åˆ°è“‹ä¸Šæ›¸", b: "ç¹¼çºŒçœ‹ä»–å¤šæ…˜" },
            { q: "å–œæ­¡çš„æ›¸æ‹æˆé›»å½±äº†ï¼Ÿ", a: "ä¸€å®šè¦å»çœ‹ï¼", b: "æ€•æ¯€åŸè‘—ï¼Œä¸çœ‹" },
            { q: "ç´„æœƒé²åˆ°äº†ï¼ŒåŸå› æ˜¯ï¼Ÿ", a: "ç¡éé ­/çœ‹æ›¸å¿˜æˆ‘", b: "æ‰“æ‰®å¤ªä¹…" },
            { q: "æ„›æƒ…çš„çµå±€å¸Œæœ›æ˜¯ï¼Ÿ", a: "éºæ†¾çš„æ·’ç¾", b: "ä¿—å¥—çš„åœ“æ»¿" }
        ];

        // --- è®Šæ•¸ ---
        let peer;
        let conn;
        let myRole = ''; // 'host' or 'client'
        let currentQIndex = 0;
        let myChoice = null;
        let opponentChoice = null;
        let score = 0;

        // --- ç•«é¢åˆ‡æ› ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- 1. æˆ¿ä¸»é‚è¼¯ (Host) ---
        function createRoom() {
            myRole = 'host';
            showScreen('screen-host');
            
            // ç”¢ç”Ÿ 4 ä½æ•¸éš¨æ©Ÿ IDï¼Œæ–¹ä¾¿è¼¸å…¥
            const randomID = Math.floor(1000 + Math.random() * 9000).toString();
            
            // åˆå§‹åŒ– Peer
            peer = new Peer(randomID); 

            peer.on('open', (id) => {
                document.getElementById('host-status').innerText = "ç­‰å¾…é€£ç·šä¸­...";
                document.getElementById('my-id-display').innerText = id;
                
                // ç”¢ç”Ÿ QR Code (åŒ…å«å®Œæ•´çš„ç¶²å€+åƒæ•¸ï¼Œé€™æ¨£åƒåŠ è€…åªè¦æƒç¢¼å°±èƒ½è‡ªå‹•å¡«å…¥)
                // æ³¨æ„ï¼šé€™è£¡å‡è¨­ä½ æ”¾åœ¨ GitHub Pagesï¼Œç¶²å€æœƒæ˜¯ä½ çš„ç¶²å€
                const currentURL = window.location.href.split('?')[0]; 
                // ç‚ºäº†æ–¹ä¾¿ï¼Œå¦‚æœæ˜¯åœ¨é›»è…¦æ¸¬è©¦ï¼Œå¯èƒ½éœ€è¦æ‰‹å‹•è¼¸ï¼Œé€™è£¡ QR Code å­˜ç´” ID æˆ–æ˜¯ å¸¶åƒæ•¸çš„ URL
                new QRCode(document.getElementById("qrcode"), {
                    text: id, // ç°¡å–®èµ·è¦‹ï¼ŒQR Code æƒå‡ºä¾†æ˜¯æ•¸å­—ï¼Œæ–¹ä¾¿å°æ–¹è¼¸å…¥
                    width: 180,
                    height: 180
                });
            });

            peer.on('connection', (c) => {
                conn = c;
                setupConnection();
                document.getElementById('host-status').innerText = "é€£ç·šæˆåŠŸï¼æº–å‚™é–‹å§‹...";
                setTimeout(startGame, 1500);
            });
            
            peer.on('error', (err) => {
                alert('ID å¯èƒ½é‡è¤‡æˆ–é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
                location.reload();
            });
        }

        function copyID() {
            const id = document.getElementById('my-id-display').innerText;
            navigator.clipboard.writeText(id);
            alert('å·²è¤‡è£½: ' + id);
        }

        // --- 2. åƒåŠ è€…é‚è¼¯ (Client) ---
        function toJoinScreen() {
            showScreen('screen-join');
        }

        function joinRoom() {
            const targetID = document.getElementById('input-id').value;
            if(!targetID) return alert('è«‹è¼¸å…¥ä»£ç¢¼');

            document.getElementById('join-status').innerText = "é€£ç·šä¸­...";
            myRole = 'client';
            
            peer = new Peer(); // åƒåŠ è€…çš„ ID éš¨æ©Ÿå³å¯

            peer.on('open', () => {
                conn = peer.connect(targetID);
                conn.on('open', () => {
                    document.getElementById('join-status').innerText = "é€£ç·šæˆåŠŸï¼";
                    setupConnection();
                });
                
                // å¦‚æœé€£ç·šå¤±æ•—
                setTimeout(() => {
                    if(!conn.open) {
                        alert('æ‰¾ä¸åˆ°æˆ¿é–“æˆ–é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªä»£ç¢¼');
                        document.getElementById('join-status').innerText = "é€£ç·šå¤±æ•—";
                    }
                }, 5000);
            });
        }

        // --- 3. å…±é€šé€£ç·šè™•ç† ---
        function setupConnection() {
            conn.on('data', (data) => {
                handleData(data);
            });
        }

        function handleData(data) {
            if (data.type === 'new_question') {
                // é¡¯ç¤ºé¡Œç›®
                showScreen('screen-game');
                resetRound();
                document.getElementById('q-text').innerText = data.q.q;
                document.getElementById('btn-a').innerText = data.q.a;
                document.getElementById('btn-b').innerText = data.q.b;
                currentQIndex = data.index;
                
            } else if (data.type === 'opponent_choice') {
                // æ”¶åˆ°å°æ‰‹é¸æ“‡ (Host æ”¶ Client, Client æ”¶ Host)
                opponentChoice = data.choice;
                checkResult();

            } else if (data.type === 'round_result') {
                // Client æ”¶åˆ° Host ç®—å¥½çš„çµæœ
                showFeedback(data.match);
                
            } else if (data.type === 'game_over') {
                // éŠæˆ²çµæŸ
                showResult(data.score);
            }
        }

        // --- 4. éŠæˆ²æµç¨‹ ---
        function startGame() {
            score = 0;
            currentQIndex = 0;
            sendQuestion();
        }

        function sendQuestion() {
            if (currentQIndex >= questions.length) {
                // çµç®—
                const resultData = { type: 'game_over', score: score };
                conn.send(resultData);
                showResult(score);
                return;
            }
            
            const q = questions[currentQIndex];
            // Host é¡¯ç¤ºé¡Œç›®
            handleData({ type: 'new_question', q: q, index: currentQIndex });
            // Host å‘Šè¨´ Client é¡Œç›®
            conn.send({ type: 'new_question', q: q, index: currentQIndex });
        }

        function resetRound() {
            myChoice = null;
            opponentChoice = null;
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('btn-a').classList.remove('btn-disabled');
            document.getElementById('btn-b').classList.remove('btn-disabled');
            document.getElementById('btn-a').style.opacity = '1';
            document.getElementById('btn-b').style.opacity = '1';
        }

        function makeChoice(choice) {
            if (myChoice) return; // é˜²æ­¢é‡è¤‡æŒ‰
            myChoice = choice;
            
            // è¦–è¦ºå›é¥‹
            document.getElementById('btn-a').classList.add('btn-disabled');
            document.getElementById('btn-b').classList.add('btn-disabled');
            document.getElementById('btn-' + choice).style.opacity = '1';
            document.getElementById('btn-' + (choice === 'a' ? 'b' : 'a')).style.opacity = '0.3';

            // å‘Šè¨´å°æ–¹æˆ‘é¸äº†ä»€éº¼
            conn.send({ type: 'opponent_choice', choice: choice });
            
            document.getElementById('game-status').innerText = "ç­‰å¾…å°æ–¹é¸æ“‡...";
            checkResult();
        }

        function checkResult() {
            // åªæœ‰ Host è² è²¬è¨ˆç®—çµæœï¼Œé¿å…ä¸åŒæ­¥
            if (myRole === 'host' && myChoice && opponentChoice) {
                const match = (myChoice === opponentChoice);
                if (match) score++;
                
                // å‘Šè¨´è‡ªå·±
                showFeedback(match);
                // å‘Šè¨´å°æ–¹
                conn.send({ type: 'round_result', match: match });

                // ä¸‹ä¸€é¡Œå€’æ•¸
                setTimeout(() => {
                    currentQIndex++;
                    sendQuestion();
                }, 2500);
            }
        }

        function showFeedback(match) {
            const fb = document.getElementById('feedback');
            fb.innerText = match ? "ğŸ’– é»˜å¥‘ï¼" : "ğŸ’¥ ç¢°æ’ï¼";
            fb.style.color = match ? "#42e695" : "#ff4757";
            fb.style.display = 'block';
        }

        function showResult(finalScore) {
            showScreen('screen-result');
            const percentage = Math.round((finalScore / questions.length) * 100);
            document.getElementById('final-score').innerText = percentage + "%";
            
            let comment = "";
            if (percentage >= 80) comment = "éˆé­‚ä¼´ä¾¶ï¼è«‹åŸåœ°çµå©šï¼";
            else if (percentage >= 50) comment = "å€‹æ€§äº’è£œï¼Œå¾ˆæœ‰è©±èŠå–”ï¼";
            else comment = "ç«æ˜Ÿæ’åœ°çƒï¼Œé€™å°æ›´æœ‰è¶£ï¼";
            document.getElementById('final-comment').innerText = comment;
        }
    </script>
</body>
</html>